<!DOCTYPE html>
<html>

<head>
    <title>REAPER Lyrics Web Interface - 2ZS</title>
    <meta charset="utf-8" />
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script> -->

    <script src="./assets/jquery.min.js"></script>
    <!-- <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
      crossorigin="anonymous"
    /> -->

    <link rel="stylesheet" href="./assets/bootstrap.min.css" />


    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            background: #333333;
            color: white;
            font-family: sans-serif;
        }
        
        .content {
            white-space: pre-wrap;
            /* overflow: scroll; */
            /* height: 600px; */
            /* white-space:break-spaces */
        }

        
        .menu {
            position: fixed;
            /* Фиксированное положение */
            right: 10px;
            
            /* Расстояние от правого края окна браузера */
            top: 30px;
            /* Расстояние сверху */
            padding: 2px;
            /* Поля вокруг текста */
           
        }

        .prev {
            position:fixed;
            /* Фиксированное положение */
            
            left: 50px;
            /* Расстояние от левого края окна браузера */
            bottom: 50px;
            /* Расстояние сверху */
            font-size: 60px;
            padding: 2px;
            /* Поля вокруг текста */
            background: hsl(117, 86%, 39%);
            /* Цвет фона */
            border: 1px solid #d7f706;
            /* Параметры рамки */
        }
        
        .row {
            top: 120;
        }

        #transport {
            position:fixed;
            /* Фиксированное положение */
            
            left: 50px;
            /* Расстояние от левого края окна браузера */
            top: 50px;
            /* Расстояние сверху */
            font-size:20px;
            padding: 2px;
            /* Поля вокруг текста */
            background: hsl(117, 86%, 39%);
            /* Цвет фона */
            border: 1px solid #d7f706;
            /* Параметры рамки */


        }
        
        #text {
            width: 95vw;
            height: 1vh;
            margin: auto;
            text-align: center;
        }
        
        #playstate {
            height: 30px;
            width: 100%;
            background: blue;
            position: absolute;
            top: 0;
            left: 0;
        }
        mark {
            /* background-color: rgb(196, 206, 13); */
            /* color: rgb(242, 96, 96); */
            /* writing-mode: vertical-rl; */
            justify-content: left

            }
        
        a {
            color: #ea8400;
        }
        
        #app {
            width: 900px;
            background: rgb(19, 14, 63);
        }
        
        #lyrics {
            width: 300px
        }
        
        #textLyr {
            width: 300px
        }
        
        #textSite {
            color: white;
            width: 300px
        }
    </style>
</head>

<body>
    
    <!-- <div id="text"></div> -->
    <!-- <div id="text" class="fittext"></div> -->
    <!-- <div id="lyrics" class ='content'>......</div>  -->
    <div class ='prev' id="prev"><h1>ghbdtn</h1></div>
    <div id="transport">.........</div>
    <div class="menu">
        
        <button id="start" type="button" class="btn btn-primary btn-lg">
        start
      </button>
        <button id="copy" type="button" class="btn btn-primary btn-lg">
        copy
      </button>
      <button id="capital" type="button" class="btn btn-primary btn-lg">
        capital
      </button>
        <button hidden id="save" type="button" class="btn btn-primary btn-lg">
        Save2Notes
      </button>
        <button hidden id="read" type="button" class="btn btn-primary btn-lg">
        ReadNotes
      </button>
        
        <button id="getTxtSuper" type="button" class="btn btn-primary btn-lg" onclick="readSuper()">
        GetTxtSuper
      </button>
        <button id="getLyric" type="button" class="btn btn-primary btn-lg">
        getMidiLyric
      </button>
        <button hidden id="lyr2Midi" type="button" class="btn btn-primary btn-lg">
        setMidiLyric
      </button>
        <button id="downloadLyr" type="button" class="btn btn-primary btn-lg">
        downloadTxt
      </button>
        <!-- <button id="pasteLyr" type="button" class="btn btn-primary btn-lg">
        pasteLyric
      </button> -->
      <button id="read-html" type="button" class="btn btn-primary btn-lg">pasteLyric</button>
        <br />
        <p id="path"></p>
        <button id="getTxt" type="button" class="btn btn-primary btn-sm" onclick="readS()" >
            GetTxt
        </button>
        <input type="file" id="file" accept=".txt" multiple />
        
            <input type="checkbox" id="showBig" name="showBig" checked />
            <label for="scales">showBig</label>
       
        <a id="message"></a>
        <button id="test0" type="button" class="btn btn-primary btn-sm" >
            test0
        </button>
        <a id="fileName"></a>
        
        
    </div>



<!-- <div id="html-output"></div> -->

    <div id="app" class="container-fluid">
        <div class="row">
            <p></p>
            <p></p>
            <p></p>
            <p></p>
            <p></p>
            <p></p>
            <p></p>
            <p>
            <div id="11" class="col-4 content">lyrics</div>
            <div id="22" class="col-4 content">textLyr</div>
            <div id="33" class="col-4 content">textSite</div>
            </p>
            <div id="lyrics" class="col-4 content"></div>
            <div id="textLyr" class="col-4 content" contenteditable="true">Пе-ред бо-ем ти-хи-е
те-плы-е ве-че-ра
И по-крыт тре-во-жно-ю
сон ти-ши-ной
У вче-ра-шних ма-льчи-ков
ги-мна-сте-рки но-вы-е
И пи-сьмо от ма-мы с_со-бой

Здесь всю ночь
го-ре-ла зве-зда о-ди-но-ка-я
И ту-ман про-зра-чный
ле-жит у ре-ки
Здесь бе-ре-зы бе-лы-е
тра-вы вы-со-ки-е
Враг не до-лжен
да-льше про-йти

А за-ка-ты а-лы-е а-лы-е а-лы-е
пе-ред бо-ем вы-стре-лы
Не слы-шны
не об э-том вме-сте
С_то-бо-ю ме-чта-ли мы
за че-ты-ре дня до во-йны

По-лы-хну-ли взры-вы и
не-бо о-бру-ши-лось
Со-лнца не ви-дать пря-чет
ды-ма сте-на
Спят бе-ре-зы бе-лы-е
тра-вы вы-со-ки-е
За-бра-ла вас ма-льчи-ки во-йна

О-тсто-я-ли ро-ди-ну
в_го-ды су-ро-вы-е
Нет сле-дов да-ле-ких
до-рог бо-е-вых
Ну-жно что-бы по-мни-ли
мы с_то-бо-ю по-мни-ли
И-ме-на ге-ро-ев сво-их

А за-ка-ты а-лы-е а-лы-е а-лы-е
пе-ред бо-ем вы-стре-лы
Не слы-шны
не об э-том вме-сте
С_то-бо-ю ме-чта-ли мы
за че-ты-ре дня до во-йны

А за-ка-ты а-лы-е а-лы-е а-лы-е
пе-ред бо-ем вы-стре-лы
Не слы-шны
не об э-том вме-сте
С_то-бо-ю ме-чта-ли мы
за че-ты-ре дня до во-йны

                </div>
            <div id="textSite" class="col-4 content" contenteditable="true"></div>
        </div>
    </div>

    <div id="playstate"></div>

    <script src="main.js"></script>
 
    <script>
        document.querySelector('#textSite').addEventListener("paste", function(e) {
            e.preventDefault();
            var text = e.clipboardData.getData("text/plain");
            document.execCommand("insertHTML", false, text);
        });


        function readSuper() {

            if (regionName == "") {
                regionName = "temp";
            }

            jQuery(document).ready(function($) {
                $.ajax({
                    url: `http://localhost:7000/midiText/${regionName}.txt`,
                    success: function(data) {
                        console.log('data')
                        console.log(data); // Выведет содержимое файла в консоль
                        document.getElementById("textLyr").textContent = data
                    }
                });
            });
        }



        function read() {
            var file = document.getElementById("file").files[0];
            
            var reader = new FileReader();
            reader.onload = function() {
                console.log("File readed!");
                document.getElementById("textLyr").innerHTML = reader.result;
            };
            console.log("Starting reading file...");
            reader.readAsText(file);
        }

        function readS() {

            var file = document.getElementById("file").files[0];
            var reader = new FileReader();
            reader.onload = function() {
                console.log("File readed!");
                document.getElementById("textLyr").innerHTML = reader.result;
            };
            console.log("Starting reading file...");
            reader.readAsText(file);
        }

        function readTxt(input) {
            let file = document.getElementById("file").files[0];
            let reader = new FileReader();
            reader.onload = function() {
                document.getElementById("textLyr").innerHTML = reader.result;
                reader.readAsText(file, "uft-8");
            };

            //alert(`File name: ${file.name}`); // например, my.png
            //alert(`Last modified: ${file.lastModified}`); // например, 1552830408824
            document.getElementById("textLyr").innerHTML = textLyr;
        }
        function splitMulti(str, tokens){
            var tempChar = tokens[0]; // We can use the first token as a temporary join character
            for(var i = 1; i < tokens.length; i++){
                str = str.split(tokens[i]).join(tempChar);
            }
            str = str.split(tempChar);
            return str;
        }           


        // вставляет содержимое буфера обмена в 3 столбик (текст с сайта, типа оригинальный)
        // document.querySelector("#pasteLyr").addEventListener("click", function() {
        //     navigator.clipboard
        //         .readText()
        //         .then(
        //             cliptext =>
        //             (document.getElementById('textSite').textContent = cliptext),
        //             err => console.log(err)
        //         );
        // })
// другой метод но он тоже не работает в сафари
        // document.querySelector("#pasteLyr").addEventListener("click", async (e) => {
        //         e.preventDefault();
        //         const cliptext = await navigator.clipboard.readText();
        //         console.log('Вставленный текст: ', cliptext);
        //          (document.getElementById('textSite').textContent = cliptext)
        // });
        
// другой метод но он тоже  работает!!!!! в сафари . НО только если копируешь из сафари
document.getElementById("read-html").addEventListener("click", async clickEvent => {
    let items = await navigator.clipboard.read();
    console.log(items)
    for (let item of items) {
        if (!item.types.includes("text/html"))
            continue;

        let reader = new FileReader;
        reader.addEventListener("load", loadEvent => {
            document.getElementById("textSite").innerHTML = reader.result;
        });
        reader.readAsText(await item.getType("text/html"));
        break;
    }
});




// неработающая функция, которая вставляет в активную миди рипера лирику из браузера
        document.querySelector("#lyr2Midi").addEventListener("click", function() {

            lyr2Reaper = document.getElementById("textLyr").textContent;


            lyr2Reaper = lyr2Reaper.replaceAll(" ", " |");
            lyr2Reaper = lyr2Reaper.replaceAll(`\n\n`, `   |`);
            lyr2Reaper = lyr2Reaper.replaceAll(`\n`, `  |`);
            lyr2Reaper = lyr2Reaper.replaceAll(`-`, `|`);

            lyr2Reaper0 = lyr2Reaper.substr(0, 200)
            lyr2Reaper1 = lyr2Reaper.substr(200, 200)
            lyr2Reaper2 = lyr2Reaper.substr(400, 200)
            lyr2Reaper3 = lyr2Reaper.substr(600, 200)
            lyr2Reaper4 = lyr2Reaper.substr(800, 200)
            lyr2Reaper5 = lyr2Reaper.substr(1000, 200)
            lyr2Reaper6 = lyr2Reaper.substr(1200, 200)
            lyr2Reaper7 = lyr2Reaper.substr(1400, 200)
            lyr2Reaper8 = lyr2Reaper.substr(1600, 200)
            lyr2Reaper9 = lyr2Reaper.substr(1800, 200)
                // str.substr(start[, length])


            console.log("lyr2Reaper", lyr2Reaper)
            console.log("lyr2Reaper0", lyr2Reaper0)
            console.log("lyr2Reaper1", lyr2Reaper1)
            console.log("lyr2Reaper2", lyr2Reaper2)
            console.log("lyr2Reaper3", lyr2Reaper3)
            console.log("lyr2Reaper4", lyr2Reaper4)
            console.log("lyr2Reaper5", lyr2Reaper5)
            console.log("lyr2Reaper6", lyr2Reaper6)
            console.log("lyr2Reaper7", lyr2Reaper7)
            console.log("lyr2Reaper8", lyr2Reaper8)
            console.log("lyr2Reaper9", lyr2Reaper9)

            wwr_req(`SET/EXTSTATE/Lyric/Y/Y`)

            wwr_req(`SET/EXTSTATE/Lyric0/Y/${lyr2Reaper0}`)
            wwr_req(`SET/EXTSTATE/Lyric1/Y/${lyr2Reaper1}`)
            wwr_req(`SET/EXTSTATE/Lyric2/Y/${lyr2Reaper2}`)
            wwr_req(`SET/EXTSTATE/Lyric3/Y/${lyr2Reaper3}`)
            wwr_req(`SET/EXTSTATE/Lyric4/Y/${lyr2Reaper4}`)
            wwr_req(`SET/EXTSTATE/Lyric5/Y/${lyr2Reaper5}`)
            wwr_req(`SET/EXTSTATE/Lyric6/Y/${lyr2Reaper6}`)
            wwr_req(`SET/EXTSTATE/Lyric7/Y/${lyr2Reaper7}`)
            wwr_req(`SET/EXTSTATE/Lyric8/Y/${lyr2Reaper8}`)
            wwr_req(`SET/EXTSTATE/Lyric9/Y/${lyr2Reaper9}`)


        })



        document.querySelector("#save").addEventListener("click", function() {
            var section = "notes";
            var key = "save";
            var value = document.getElementById("textLyr").textContent;
            console.log("SAVE");
            wwr_start();
            wwr_req("SET/EXTSTATEPERSIST/" + section + "/" + key + "/" + value);
        });

        document.querySelector("#read").addEventListener("click", function() {
            var section = "notes";
            var key = "read";
            var value = "y";
            wwr_start();
            wwr_req("SET/EXTSTATEPERSIST/" + section + "/" + key + "/" + value);
            wwr_req_recur("GET/PROJEXTSTATE/2ZS_Lyrics/notes", 3000);
        });

        document
            .querySelector("#downloadLyr")
            .addEventListener("click", function() {
                if (regionName == "") {
                    regionName = "temp";
                }
                downloadTextFile(regionName);
                // wwr_req_recur_cancel("GET/PROJEXTSTATE/2ZS_Lyrics/regionName")
            });

        function downloadTextFile(regionName) {
            // Open Reaper resource path
            //wwr_req(encodeURIComponent(REApath));

            // Create text file from array input
            var textFile = null,
                makeTextFile = function(arr) {
                    var arrToText = new Blob([arr], {
                        type: "text/plain"
                    });
                    // If we are replacing a previously generated file we need to
                    // manually revoke the object URL to avoid memory leaks.
                    if (textFile !== null) {
                        window.URL.revokeObjectURL(textFile);
                    }
                    textFile = window.URL.createObjectURL(arrToText);
                    return textFile;
                };

            // Create page element for link to file
            var link = document.createElement("a");
            link.setAttribute("download", regionName + ".txt");
            // link.href = makeTextFile(jsonFullTable);
            link.href = makeTextFile(
                document.getElementById("textLyr").textContent
            );
            // Spoof user clicking on new download link
            document.body.appendChild(link);
            window.requestAnimationFrame(function() {
                var event = new MouseEvent("click");
                link.dispatchEvent(event);
                document.body.removeChild(link);
            });
        }

        //utf8 to 1251 converter (1 byte format, RU/EN support only + any other symbols) by drgluck
        function utf8_decode(aa) {
            var bb = '',
                c = 0;
            for (var i = 0; i < aa.length; i++) {
                c = aa.charCodeAt(i);
                if (c > 127) {
                    if (c > 1024) {
                        if (c == 1025) {
                            c = 1016;
                        } else if (c == 1105) {
                            c = 1032;
                        }
                        bb += String.fromCharCode(c - 848);
                    }
                } else {
                    bb += aa.charAt(i);
                }
            }
            return bb;
        }


       function UnicodeToWin1251(s) {
         var DMap = {0: 0, 1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 6, 7: 7, 8: 8, 9: 9, 10: 10, 11: 11, 12: 12, 13: 13, 14: 14, 15: 15, 16: 16, 17: 17, 18: 18, 19: 19, 20: 20, 21: 21, 22: 22, 23: 23, 24: 24, 25: 25, 26: 26, 27: 27, 28: 28, 29: 29, 30: 30, 31: 31, 32: 32, 33: 33, 34: 34, 35: 35, 36: 36, 37: 37, 38: 38, 39: 39, 40: 40, 41: 41, 42: 42, 43: 43, 44: 44, 45: 45, 46: 46, 47: 47, 48: 48, 49: 49, 50: 50, 51: 51, 52: 52, 53: 53, 54: 54, 55: 55, 56: 56, 57: 57, 58: 58, 59: 59, 60: 60, 61: 61, 62: 62, 63: 63, 64: 64, 65: 65, 66: 66, 67: 67, 68: 68, 69: 69, 70: 70, 71: 71, 72: 72, 73: 73, 74: 74, 75: 75, 76: 76, 77: 77, 78: 78, 79: 79, 80: 80, 81: 81, 82: 82, 83: 83, 84: 84, 85: 85, 86: 86, 87: 87, 88: 88, 89: 89, 90: 90, 91: 91, 92: 92, 93: 93, 94: 94, 95: 95, 96: 96, 97: 97, 98: 98, 99: 99, 100: 100, 101: 101, 102: 102, 103: 103, 104: 104, 105: 105, 106: 106, 107: 107, 108: 108, 109: 109, 110: 110, 111: 111, 112: 112, 113: 113, 114: 114, 115: 115, 116: 116, 117: 117, 118: 118, 119: 119, 120: 120, 121: 121, 122: 122, 123: 123, 124: 124, 125: 125, 126: 126, 127: 127, 1027: 129, 8225: 135, 1046: 198, 8222: 132, 1047: 199, 1168: 165, 1048: 200, 1113: 154, 1049: 201, 1045: 197, 1050: 202, 1028: 170, 160: 160, 1040: 192, 1051: 203, 164: 164, 166: 166, 167: 167, 169: 169, 171: 171, 172: 172, 173: 173, 174: 174, 1053: 205, 176: 176, 177: 177, 1114: 156, 181: 181, 182: 182, 183: 183, 8221: 148, 187: 187, 1029: 189, 1056: 208, 1057: 209, 1058: 210, 8364: 136, 1112: 188, 1115: 158, 1059: 211, 1060: 212, 1030: 178, 1061: 213, 1062: 214, 1063: 215, 1116: 157, 1064: 216, 1065: 217, 1031: 175, 1066: 218, 1067: 219, 1068: 220, 1069: 221, 1070: 222, 1032: 163, 8226: 149, 1071: 223, 1072: 224, 8482: 153, 1073: 225, 8240: 137, 1118: 162, 1074: 226, 1110: 179, 8230: 133, 1075: 227, 1033: 138, 1076: 228, 1077: 229, 8211: 150, 1078: 230, 1119: 159, 1079: 231, 1042: 194, 1080: 232, 1034: 140, 1025: 168, 1081: 233, 1082: 234, 8212: 151, 1083: 235, 1169: 180, 1084: 236, 1052: 204, 1085: 237, 1035: 142, 1086: 238, 1087: 239, 1088: 240, 1089: 241, 1090: 242, 1036: 141, 1041: 193, 1091: 243, 1092: 244, 8224: 134, 1093: 245, 8470: 185, 1094: 246, 1054: 206, 1095: 247, 1096: 248, 8249: 139, 1097: 249, 1098: 250, 1044: 196, 1099: 251, 1111: 191, 1055: 207, 1100: 252, 1038: 161, 8220: 147, 1101: 253, 8250: 155, 1102: 254, 8216: 145, 1103: 255, 1043: 195, 1105: 184, 1039: 143, 1026: 128, 1106: 144, 8218: 130, 1107: 131, 8217: 146, 1108: 186, 1109: 190}
        
            var L = []
            for (var i=0; i<s.length; i++) {
                var ord = s.charCodeAt(i)
                if (!(ord in DMap))
                    throw "Character "+s.charAt(i)+" isn't supported by win1251!"
                L.push('%' + DMap[ord].toString(16));
            }
            return L.join('')
}


/**
*
*  UTF-8 data encode / decode
*  [url]http://www.webtoolkit.info/[/url]
*
**/
 
var Utf8 = {
 
 // public method for url encoding
 encode : function (string) {
     string = string.replace(/\r\n/g,"\n");
     var utftext = "";

     for (var n = 0; n < string.length; n++) {

         var c = string.charCodeAt(n);

         if (c < 128) {
             utftext += String.fromCharCode(c);
         }
         else if((c > 127) && (c < 2048)) {
             utftext += String.fromCharCode((c >> 6) | 192);
             utftext += String.fromCharCode((c & 63) | 128);
         }
         else {
             utftext += String.fromCharCode((c >> 12) | 224);
             utftext += String.fromCharCode(((c >> 6) & 63) | 128);
             utftext += String.fromCharCode((c & 63) | 128);
         }

     }

     return utftext;
 },

 // public method for url decoding
 decode : function (utftext) {
     var string = "";
     var i = 0;
     var c = c1 = c2 = 0;

     while ( i < utftext.length ) {

         c = utftext.charCodeAt(i);

         if (c < 128) {
             string += String.fromCharCode(c);
             i++;
         }
         else if((c > 191) && (c < 224)) {
             c2 = utftext.charCodeAt(i+1);
             string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
             i += 2;
         }
         else {
             c2 = utftext.charCodeAt(i+1);
             c3 = utftext.charCodeAt(i+2);
             string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
             i += 3;
         }

     }

     return string;
 }

}

// function conv(textFromMidi) {
//     var iconv = require('iconv-lite');

//     // text = 'Ýé |òî|ðå|ðî | |æèçíü |êàê |ìèã | |Î|ïÿòü |çâó|÷èò |òðó|áû | |ïðè|çûâ|íûé |çîâ | |Ýé |òî|ðå|ðî |òû |è|ëè |áûê | |êà|÷à|åò|ñÿ |÷à|øà |âå|ñîâ | | |Áîã |õðà|íèò |òå|áÿ | |ñìåðòü |ùà|äèò |òå|áÿ | | |Íå|áà |áå|ëûé |ïëà|òîê | |êðîâü |è |æåë|òûé |ïå|ñîê | |Êðèê |îò|÷à|ÿíü|ÿ | |áûê |æè|âà|ÿ |ìè|øåíü | |Ïîä |âîñ|òîð|æåí|íûé |âîé | |òû |èã|ðà|åøü |ñóäü|áîé | |Ïóñòü |íå |çíà|åò |íèê|òî | |÷òî |òâî|ðèò|ñÿ |â_äó|øå | | |Ýé |òî|ðå|ðî | |ñûí |âäî|âû | |Òâîé |êðàñ|íûé |ïëàù |òâîé | |òðà|óð|íûé |ïîê|ðîâ | |Ýé |òî|ðå|ðî |òû | |áó|äåøü |ó|áèò | |Ïîä |ïåñ|íþ | |ìàä|ðèä|ñêèõ |÷à|ñîâ | | |Áîã |õðà|íèò |òå|áÿ | |ñìåðòü |ùà|äèò |òå|áÿ | | |Íå|áà |áå|ëûé |ïëà|òîê | |êðîâü |è |æåë|òûé |ïå|ñîê | |Êðèê |îò|÷à|ÿíü|ÿ | |áûê |æè|âà|ÿ |ìè|øåíü | |Ïîä |âîñ|òîð|æåí|íûé |âîé | |òû |èã|ðà|åøü |ñóäü|áîé | |Ïóñòü |íå |çíà|åò |íè|êòî | |÷òî |òâî|ðèò|ñÿ |â_äó|øå | | |Íå|áà |áå|ëûé |ïëà|òîê | |êðîâü |è |æåë|òûé |ïå|ñîê | |Êðèê |îò|÷à|ÿíü|ÿ | |áûê |æè|âà|ÿ |ìè|øåíü | |Ïîä |âîñ|òîð|æåí|íûé |âîé | |òû |èã|ðà|åøü |ñóäü|áîé | |Ïóñòü |íå |çíà|åò |íè|êòî | |÷òî |òâî|ðèò|ñÿ |â_äó|øå | |'

//     buf = iconv.encode(textFromMidi, 'latin-1');

//     // Convert from an encoded buffer to a js string.
//     str = iconv.decode(Buffer.from(buf), 'win1251');

//     // Convert from a js string to an encoded buffer.
//     // buf = iconv.encode("Sample input string", 'win1251');

//     // Check if encoding is supported
//     iconv.encodingExists("us-ascii")

//     // console.log(buf)
//     // console.log(str)
//     return str

// }




        document
            .querySelector("#getLyric")
            .addEventListener("click", function() {
                let textL = allLyric;

                console.log("textL", textL);

                // let LyricTxt

                // LyricTxt=LyricTxt.encode('cp1251')
                // # print('*******************')
                // # print(LyricTxt)
                // LyricTxt=LyricTxt.decode('latin-1')
                // # print('*******************')
                // # print(LyricTxt)
                // # print('*******************')



                // # print (LyricTxt)
                // LyricTxt = allLyric.encode(encoding = 'utf-8')
                // LyricTxt = allLyric.decode("windows-1251")

                // let encoder = new TextEncoder().encode(allLyric);
                // console.log("allLyric", encoder);
                // LyricTxt = new TextDecoder('cp1251').decode(encoder);
                // console.log("LyricTxt", LyricTxt);
                // console.log("textL", textL);

                // textL2  = conv(textL)


                // console.log("textL2", textL2);

                // console.log('1', UnicodeToWin1251(textL))
                    // console.log('2',  utf8_decode(textL))
                    //     console.log( '3', Utf8.decode(textL))
                    //         console.log('4', decodeURIComponent(textL.split("").map(function(ch) { return "%"+ch.charCodeAt(0).toString(16); }).join("")))

                // textL = UnicodeToWin1251(textL) 
                // textL = utf8_decode(textL)

                // textL = Utf8.decode(textL)
                // textL = decodeURIComponent(textL.split("").map(function(ch) { return "%"+ch.charCodeAt(0).toString(16); }).join("")) // "Яндек"
                // textL = conv(textL)
                // ___________________________________________
                textL = textL.replaceAll("à", "а");
                textL = textL.replaceAll("á", "б");
                textL = textL.replaceAll("â", "в");
                textL = textL.replaceAll("ã", "г");
                textL = textL.replaceAll("ä", "д");
                textL = textL.replaceAll("å", "е");
                textL = textL.replaceAll("¸", "ё");
                textL = textL.replaceAll("æ", "ж");
                textL = textL.replaceAll("ç", "з");
                textL = textL.replaceAll("è", "и");
                textL = textL.replaceAll("é", "й");
                textL = textL.replaceAll("ê", "к");
                textL = textL.replaceAll("ë", "л");
                textL = textL.replaceAll("ì", "м");
                textL = textL.replaceAll("í", "н");
                textL = textL.replaceAll("î", "о");
                textL = textL.replaceAll("ï", "п");
                textL = textL.replaceAll("ð", "р");
                textL = textL.replaceAll("ñ", "с");
                textL = textL.replaceAll("ò", "т");
                textL = textL.replaceAll("ó", "у");
                textL = textL.replaceAll("ô", "ф");
                textL = textL.replaceAll("õ", "х");
                textL = textL.replaceAll("ö", "ц");
                textL = textL.replaceAll("÷", "ч");
                textL = textL.replaceAll("ø", "ш");
                textL = textL.replaceAll("ù", "щ");
                textL = textL.replaceAll("ú", "ъ");
                textL = textL.replaceAll("ü", "ь");
                textL = textL.replaceAll("û", "ы");
                textL = textL.replaceAll("ý", "э");
                textL = textL.replaceAll("þ", "ю");
                textL = textL.replaceAll("ÿ", "я");

                textL = textL.replaceAll("À", "А");
                textL = textL.replaceAll("Á", "Б");
                textL = textL.replaceAll("Â", "В");
                textL = textL.replaceAll("Ã", "Г");
                textL = textL.replaceAll("Ä", "Д");
                textL = textL.replaceAll("Å", "Е");
                textL = textL.replaceAll("¨", "Ё");
                textL = textL.replaceAll("Æ", "Ж");
                textL = textL.replaceAll("Ç", "З");
                textL = textL.replaceAll("È", "И");
                textL = textL.replaceAll("É", "Й");
                textL = textL.replaceAll("Ê", "К");
                textL = textL.replaceAll("Ë", "Л");
                textL = textL.replaceAll("Ì", "М");
                textL = textL.replaceAll("Í", "Н");
                textL = textL.replaceAll("Î", "О");
                textL = textL.replaceAll("Ï", "П");
                textL = textL.replaceAll("Ð", "Р");
                textL = textL.replaceAll("Ñ", "С");
                textL = textL.replaceAll("Ò", "Т");
                textL = textL.replaceAll("Ó", "У");
                textL = textL.replaceAll("Ô", "Ф");
                textL = textL.replaceAll("Õ", "Х");
                textL = textL.replaceAll("Ö", "Ц");
                textL = textL.replaceAll("×", "Ч");
                textL = textL.replaceAll("Ø", "Ш");
                textL = textL.replaceAll("Ù", "Щ");
                textL = textL.replaceAll("Ú", "Ъ");
                textL = textL.replaceAll("Ü", "Ь");
                textL = textL.replaceAll("Û", "Ы");
                textL = textL.replaceAll("Ý", "Э");
                textL = textL.replaceAll("Þ", "Ю");
                textL = textL.replaceAll("ß", "Я");


                textL = textL.replaceAll("³", "і");
                textL = textL.replaceAll("¿", "ї");
                textL = textL.replaceAll("º", "є");
                textL = textL.replaceAll("²", "I");

                textL = textL.replaceAll("Ƹ", "Жё");
                textL = textL.replaceAll("ѳ", "Сі");
                textL = textL.replaceAll("", "п’є");
                textL = textL.replaceAll("ϳ", "Пі");
                textL = textL.replaceAll("ĳ", "Ді");
                textL = textL.replaceAll("˸", "Лё");
                textL = textL.replaceAll("ճ", "Хi");
                textL = textL.replaceAll("ֳֳ ", "Цi"); //not work...
                textL = textL.replaceAll("ͳ", "Нi");
                textL = textL.replaceAll("ª", "Є");
                textL = textL.replaceAll("ǳ", "Зі");
                textL = textL.replaceAll("¢", "ў");
                textL = textL.replaceAll("Ƴ", "Жi");
                textL = textL.replaceAll("Ҹ", "Тё");
                textL = textL.replaceAll("׸", "Чё");
                // _______________________________________

                // textL = textL.replaceAll("ͳ", "Нi");
                // textL = textL.replaceAll("", "Нi");
                // textL = textL.replaceAll("ͳ", "Нi");
                // textL = textL.replaceAll("ͳ", "Нi");
                // textL = textL.replaceAll("", "Нi");



                textL = textL.replaceAll(` | |`, `\n`);
                textL = textL.replaceAll(`\n |`, `\n\n`);
                textL = textL.replaceAll(` |`, ` `);
                textL = textL.replaceAll(`|`, `-`);

                textL = textL.replaceAll(`\\n\\n-`, `\n\n`);
                textL = textL.replaceAll(`\\n-`, `\n`);
                // textL = textL.replaceAll(`-\n`, `\n`);

                // textL=textL.replaceAll(`|`, ``)
                // textL=textL.replaceAll(new RegExp('\n', "g"), " ")
                // textL=textL.replaceAll("\n", ``)
                // textL=textL.replaceAll(` -\n-`, `\n\n`)

                // textL=textL.replaceAll(`|\n|`, `\n`)
                // textL=textL.replaceAll(` |`, ` `)
                // textL=textL.replaceAll(`\n|`, `\n`)
                // textL=textL.replaceAll(`|`, `-`)

                if (textL[0] === "-") {
                    textL = textL.slice(1);
                }

                // console.log("textL2", textL);
                document.getElementById("textLyr").textContent = textL;
            });

        function razdelit(string, start, finish) {
            // console.log("string",string)
            str = string.substring(start, finish);

            strs = str.split(" ");
            for (i = 0; i < strs.length - 2; i++) {
                if (strs[i] === "не") {
                    strs[i + 1] = "не " + strs[i + 1];
                    strs.splice(i, 1);
                }
            }

            // console.log("strs", strs)

            lenStrHalf = Math.floor((strs.length + 1) / 2);

            // console.log("lenStrHalf",lenStrHalf)
            ttt = strs[lenStrHalf];
            // console.log("ttt",ttt)

            strs.splice(lenStrHalf, 1);
            strs[lenStrHalf - 1] = strs[lenStrHalf - 1] + `\n` + ttt;

            strsJoin = strs.join(" ");
            // console.log("strJoin",strsJoin)

            el = string.substr(0, start) + strsJoin + string.substr(finish);
            // console.log("el",el)
            return el;
        }

        document.querySelector("#copy").addEventListener("click", function() {
            let eee = document.getElementById("textLyr").textContent;
            eee = eee.replaceAll("-", "");
            eee = eee.replaceAll("=", "-");
            document.getElementById("textSite").textContent = eee;
        });

       
        document.querySelector("#capital").addEventListener("click", function() {
            let $el = document.getElementById("textLyr").textContent;

            vowels = "ѳYyUuOoAaJjEeiiіїєуеёэоаыяиюIУЕЁЭОАЫЯИЮ"; // ZADAJUTSJA ZDES!!!

            //.split(',')
            const charsDelete = `,.?!()`; //document.querySelector('#charsDelete').value

            //$el = document.querySelector('#editor').textContent
            console.log($el)
            

            let posSpaces = [];
            let posBreakLine = [];
            let posAbzac = [];
            let posGlasnye = [];
            let posUpCase = [];
            let searchVolwels = new RegExp(`[${vowels}]`, "g");
            let searchVolwel = new RegExp(`[${vowels}]`);
            let upCase = false;
            //debugger 

            if ($el.substring($el.length, $el.length + 1) != `\n`) {
                $el = $el + `\n`;
            }

            posBreakLine = [];
            posAbzac = [];
            $el = $el.replaceAll(`\n `, `\n`);
            $el = $el.replaceAll(` \n`, `\n`);

            //<span style="color: #ff6600;">цветом</span>
            $el = $el.substr(0, 1).toUpperCase() + $el.substr(1);
            for (i = 0; i < $el.length; i++) {
                // console.log('i',i)

                if ($el.substring(i, i + 3) === `\n \n`) {
                    
                    upCase = true;
                    posAbzac.push(i);
                    i = i + 2;
                } else if ($el.substring(i, i + 2) === `\n\n` || $el.substring(i, i + 2) === `\n\r`) {
                    upCase = true;
                    posAbzac.push(i);
                    i = i + 1;
                }

                if (
                    ($el.substring(i, i + 1) === `\n`) &
                    ($el.substring(i + 1, i + 2) != " ") &
                    ($el.substring(i + 1, i + 2) != `\n`) &
                    ($el.substring(i + 2, i + 3) != `\n`)
                ) {
                    posBreakLine.push(i);


                    if (upCase) {
                        let upp = $el.substring(i + 1, i + 2);
                        $el =
                            $el.substr(0, i + 1) + upp.toUpperCase() + $el.substr(i + 2);
                        upCase = false;
                        // console.log("upp", upp)
                    } else {
                        let low = $el.substring(i + 1, i + 2);
                        $el =
                            $el.substr(0, i + 1) + low.toLowerCase() + $el.substr(i + 2);

                        upCase = true;
                        // console.log("low", low)
                    }
                }
            }

            for (i = 0; i < $el.length; i++) {
                // console.log('i',i)
                if ($el.substring(i, i + 1) === ` `) {
                    posSpaces.push(i);
                }
            }

            for (i = 0; i < $el.length; i++) {
                // console.log('searchVolwels',searchVolwels)
                if (searchVolwels.test($el.substring(i, i + 1))) {
                    // console.log('volwels')
                    posGlasnye.push(i);
                }
                if (
                    $el.substring(i, i + 1) === $el.substring(i, i + 1).toUpperCase()
                ) {
                    // console.log('toUpperCase')
                    posUpCase.push(i);
                }
            }

            // console.log("posSpaces", posSpaces)
            // console.log("posBreakLine", posBreakLine)
            // console.log("posAbzac", posAbzac)
            // console.log("posGlasnye", posGlasnye)
            // console.log("posUpCase", posUpCase)
            // console.log("$el", $el)

            

            // a.map(item => $el = star($el, item))
            // $el = $el.replace(/- /g," ")
            // //$el = $el.replace(new RegExp(`- `, "g"), " ") // variant
            // document.querySelector("#textLyr").textContent = $el;

            function star(string, token) {
                return string.split(token).join(token + "-");
            }
            // for (i = 0; i < $el.length; i++) {
            //     if ($el.substring(i, i + 1).charCodeAt(0) > 1039 && $el.substring(i, i + 1).charCodeAt(0) < 1072) {
            //         console.log('BIGG letter', $el.substring(i, i + 1), $el.substring(i, i + 1).charCodeAt(0))
            //         $el = $el.substring(0, i) + `<span style="color: #ff6600;">` + $el.substring(i, i + 1) + `</span>` + $el.substring(i + 1)
            //         i = i + 37
            //     }



            // }
            //<span style="color: #ff6600;">цветом</span>

            document.getElementById("textLyr").textContent = $el

            // console.log($el)
        });



        document.querySelector("#start").addEventListener("click", function() {
            let $el = document.getElementById("textSite").textContent;

            vowels = "ѳYyUuOoAaJjEeiiіїєуеёэоаыяиюIУЕЁЭОАЫЯИЮ"; // ZADAJUTSJA ZDES!!!

            //.split(',')
            const charsDelete = `,.?!()`; //document.querySelector('#charsDelete').value

            //$el = document.querySelector('#editor').textContent
            console.log($el)
            $el = $el.replaceAll(`Припев:\n`, "");
            $el = $el.replaceAll(`припев:\n`, "");
            $el = $el.replaceAll(`Припев:`, "");
            $el = $el.replaceAll(`Пред припев:`, "");
            // $el = $el.replaceAll(`\n\r`, `\n\n`);
            $el = $el.replaceAll(`\n\n\n`, "\n\n");

            $el = $el.replace(/          /g, " ");
            $el = $el.replace(/         /g, " ");
            $el = $el.replace(/        /g, " ");
            $el = $el.replace(/       /g, " ");
            $el = $el.replace(/      /g, " ");
            $el = $el.replace(/     /g, " ");
            $el = $el.replace(/    /g, " ");
            $el = $el.replace(/   /g, " ");
            $el = $el.replace(/   /g, " ");
            $el = $el.replace(/  /g, " ");
            $el = $el.replace(/  /g, " ");

            for (i = 0; i < $el.length; i++) {
                if (
                    ($el.substring(i, i + 2) === `. `) &
                    ($el.substring(i + 3, i + 4) != `\n`)
                ) {
                    $el = $el.substr(0, i + 1) + `\n` + $el.substr(i + 2);
                } else if (
                    ($el.substring(i, i + 2) === `! `) &
                    ($el.substring(i + 3, i + 4) != `\n`)
                ) {
                    $el = $el.substr(0, i + 1) + `\n` + $el.substr(i + 2);
                } else if (
                    ($el.substring(i, i + 2) === `? `) &
                    ($el.substring(i + 3, i + 4) != `\n`)
                ) {
                    $el = $el.substr(0, i + 1) + `\n` + $el.substr(i + 2);
                }
            }

            $el = $el.replace(new RegExp(`[${charsDelete}]`, "g"), "");
            $el = $el.replaceAll(" ", " ");
            
            $el = $el.replaceAll(" - ", " ");
            // $el = $el.replaceAll(`-\n`, `\n`);
            $el = $el.replaceAll(" – ", " ");
            $el = $el.replaceAll("–", " ");

            $el = $el.replaceAll(" в ", " в_");
            $el = $el.replaceAll(" б ", "_б ");
            $el = $el.replaceAll("В ", "В_");
            $el = $el.replaceAll(" с ", " с_");
            $el = $el.replaceAll("С ", "С_");
            $el = $el.replaceAll(" к ", " к_");
            $el = $el.replaceAll("К ", "К_");
            $el = $el.replaceAll(" ж ", "_ж ");
            $el = $el.replaceAll(";", "");
            $el = $el.replaceAll(":", "");
            $el = $el.replaceAll('…', "")
            $el = $el.replaceAll("—", "");
            $el = $el.replaceAll(" -", "");
            $el = $el.replaceAll(" - ", "");
            $el = $el.replaceAll("- ", "");
            // $el = $el.replaceAll('"', "");

            let posSpaces = [];
            let posBreakLine = [];
            let posAbzac = [];
            let posGlasnye = [];
            let posUpCase = [];
            let searchVolwels = new RegExp(`[${vowels}]`, "g");
            let searchVolwel = new RegExp(`[${vowels}]`);
            let upCase = false;
            //debugger 

            if ($el.substring($el.length, $el.length + 1) != `\n`) {
                $el = $el + `\n`;
            }

            for (i = 0; i < $el.length; i++) {
                if ($el.substring(i, i + 3) === `\n \n`) {
                    posAbzac.push(i);
                    i = i + 1;
                }
                if ($el.substring(i, i + 1) === `\n`) {
                    posBreakLine.push(i);
                    if (posBreakLine.length > 1) {
                        if (
                            posBreakLine[posBreakLine.length - 1] -
                            posBreakLine[posBreakLine.length - 2] >
                            28
                        ) {
                            $el = razdelit(
                                $el,
                                posBreakLine[posBreakLine.length - 2],
                                posBreakLine[posBreakLine.length - 1]
                            );
                            i = 0;
                        }
                    } else if (posBreakLine.length === 1) {
                        if (posBreakLine[0] > 28) {
                            $el = razdelit($el, 0, posBreakLine[0]);
                            i = 0;
                        }
                    }
                }
            }

            posBreakLine = [];
            posAbzac = [];
            $el = $el.replaceAll(`\n `, `\n`);
            $el = $el.replaceAll(` \n`, `\n`);

            //<span style="color: #ff6600;">цветом</span>
            
            for (i = 0; i < $el.length; i++) {
                // console.log('i',i)

                if ($el.substring(i, i + 3) === `\n \n`) {
                    upCase = true;
                    posAbzac.push(i);
                    i = i + 2;
                } else if ($el.substring(i, i + 2) === `\n\n` || $el.substring(i, i + 2) === `\n\r`) {
                    upCase = true;
                    posAbzac.push(i);
                    i = i + 1;
                }

                if (
                    ($el.substring(i, i + 1) === `\n`) &
                    ($el.substring(i + 1, i + 2) != " ") &
                    ($el.substring(i + 1, i + 2) != `\n`) &
                    ($el.substring(i + 2, i + 3) != `\n`)
                ) {
                    posBreakLine.push(i);

                    if (upCase) {
                        let upp = $el.substring(i + 1, i + 2);
                        $el =
                            $el.substr(0, i + 1) + upp.toUpperCase() + $el.substr(i + 2);
                        upCase = false;
                        // console.log("upp", upp)
                    } else {
                        let low = $el.substring(i + 1, i + 2);
                        $el =
                            $el.substr(0, i + 1) + low.toLowerCase() + $el.substr(i + 2);

                        upCase = true;
                        // console.log("low", low)
                    }
                }
            }

            for (i = 0; i < $el.length; i++) {
                // console.log('i',i)
                if ($el.substring(i, i + 1) === ` `) {
                    posSpaces.push(i);
                }
            }

            for (i = 0; i < $el.length; i++) {
                // console.log('searchVolwels',searchVolwels)
                if (searchVolwels.test($el.substring(i, i + 1))) {
                    // console.log('volwels')
                    posGlasnye.push(i);
                }
                if (
                    $el.substring(i, i + 1) === $el.substring(i, i + 1).toUpperCase()
                ) {
                    // console.log('toUpperCase')
                    posUpCase.push(i);
                }
            }

            // console.log("posSpaces", posSpaces)
            // console.log("posBreakLine", posBreakLine)
            // console.log("posAbzac", posAbzac)
            // console.log("posGlasnye", posGlasnye)
            // console.log("posUpCase", posUpCase)
            // console.log("$el", $el)

            // создание модели ПЕСНЯ
            // document.getElementById("textLyr").textContent = $el;

            let kuplets = $el.split(`\n \n`);
            let Pesnja = kuplets.map((kuplet) => {
                let lines = kuplet.split(`\n`);
                lines.map((line) => {
                    words = line.split(` `);
                    syllables = words.map((word) => {
                        //return word.split(new RegExp(`(?=[${vowels}])`, "g"))
                        return word.split(/[ѳYyUuOoAaJjEeiіїєуеёэоаыяиюIУЕЁЭОАЫЯИЮ]/g);
                    });
                    // console.log(syllables)
                });
            });

            // document.querySelector("#textLyr").textContent = $el;

            $el = $el.replaceAll("-", "-=");
            $el = $el.replaceAll("==", "=");
            // document.querySelector("#textLyr").textContent = $el;
            a = "ѳ,Y,y,U,u,O,o,A,a,J,j,E,e,і,ї,є,i,у,е,ё,э,о,а,ы,я,и,ю,I,У,Е,Ё,Э,О,А,Ы,Я,И,Ю".split(",");

            //!!!!!!!!!!!!!!!!!!!!!!
            //debugger
            let statVolwels = false;
            for (i = $el.length; i != 0; i--) {
                if (searchVolwel.test($el.substr(i - 1, 1)) && !statVolwels) {
                    statVolwels = true;
                } else if (searchVolwel.test($el.substr(i - 1, 1)) && statVolwels) {
                    $el = $el.substr(0, i) + `-` + $el.substr(i);
                }

                if ($el.substr(i - 1, 1) === " ") {
                    statVolwels = false;
                } else if ($el.substr(i - 1, 1) === `\n`) {
                    statVolwels = false;
                } else if ($el.substr(i - 1, 1) === `=`) {
                    statVolwels = false;
                }

                //console.log($el)
                let f = $el.substr(i - 1, 1);
                // console.log(f)
            }

            // a.map(item => $el = star($el, item))
            // $el = $el.replace(/- /g," ")
            // //$el = $el.replace(new RegExp(`- `, "g"), " ") // variant
            // document.querySelector("#textLyr").textContent = $el;

            function star(string, token) {
                return string.split(token).join(token + "-");
            }
            // for (i = 0; i < $el.length; i++) {
            //     if ($el.substring(i, i + 1).charCodeAt(0) > 1039 && $el.substring(i, i + 1).charCodeAt(0) < 1072) {
            //         console.log('BIGG letter', $el.substring(i, i + 1), $el.substring(i, i + 1).charCodeAt(0))
            //         $el = $el.substring(0, i) + `<span style="color: #ff6600;">` + $el.substring(i, i + 1) + `</span>` + $el.substring(i + 1)
            //         i = i + 37
            //     }



            // }
            //<span style="color: #ff6600;">цветом</span>
            $el = $el.trim()
            $el = $el.substr(0, 1).toUpperCase() + $el.substr(1);

            document.getElementById("textLyr").textContent = $el+ '\n\n'

            $el = document.getElementById("textLyr").textContent
            // let kuplets1 = $el.split(`\n \n`);
            // let Pesnja1 = kuplets1.map((kuplet) => {
            //     let lines1 = kuplets1.split(`\n`);
            //     lines1.map((line) => {
                   
            //     });
            // });


            // console.log($el)
        });


        $("#textLyr").keydown(function(e) {
            if (e.keyCode == 13) {
                //not work
                console.log('enter')
                e.shiftKey = true
                e.ctrlKey = true
                console.log(e)

            }
        });

        document
            .getElementById("textSite")
            .addEventListener("change", function() {
                document.getElementById(
                    "textLyr"
                ).textContent = document.getElementById("textSite").textContent;
            });
</script>
    
<script>
        //let textP //= document.getElementById('textLyr').textContent

        function getSlogi(textP) {
            ///var html1=""

            // if (maxbeats == 0) {
            //   html="<div class=\"text\">(no MIDI lyrics found on track "+lyrictrack+")</div>";
            // }
            // else {
            //   var curm=1, curb=1; curd=1;
            //   var re=/^(\d+)\.(\d+)\.(\d+)$/.exec(playpos)
            //   if (re && re.length == 4) {
            //     curm=re[1];
            //     curb=re[2];
            //     curd=re[3];
            //   }

            // console.log('text', textP)

            kuplets = textP.split(`\n\n`);
            kuplets = kuplets.map((kuplet) => {
                return (kuplet += `\n\n`);
            });
            // console.log('kuplets', kuplets)

            // tt = kuplets.join('')
            // console.log('tt', tt)

            str = kuplets.join(``).split(`\n`);
            str = str.map((st) => {
                st = st.trim();
                return (st = ` ` + st + `\n`);
            });
            // console.log('str', str)
            // tt = str.join('')
            // console.log('tt', tt)

            words = str.join(``).split(/[ ]/g);
            words = words.map((word) => {
                return (word = ` ` + word);
            });
            words[0] = "";
            // console.log('words', words)

            // tt = words.join(' ')
            // console.log('tt', tt)

            slogi = words.join(` `).split(/[ -]/g);

            // console.log('slogi', slogi)

            ///сборка обратно из слогов в текст

            toText = slogi.join(`-`);
            toText = toText.replace(/--/g, ` `);

            str1 = toText.split(`\n`);
            str1 = str1.map((st) => {
                st = st.trim();
                return (st = st + `\n`);
            });
            toText = str1.join("");

            // console.log(toText)

            // console.log(lyrictabla)

            //html1 += textP

            // var lines=0;
            // debugger
            // var m=Math.max(curm-lyriclines/4, 1);
            // for (lines=0; lines < lyriclines; ++lines, ++m) {
            //   html += "<div class=\"measure\">"+m+"</div>";
            //   html += "<div class=\"text\">";
            //   var b;
            //   for (b=1; b <= maxbeats; ++b) {
            //     if (b > 1) html += " ";
            //     if (m == curm && b == curb) html += "<b>";
            //     if (lyrics[m] && lyrics[m][b])
            //       html += simple_unescape(lyrics[m][b]).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            //     else html += "&#x2219;";
            //     if (m == curm && b == curb) html += "</b>";
            //   }
            //   html += "</div>";
            // }

            //  }
            //document.getElementById("lyrics").innerHTML=html1;
            //document.getElementById("lyrics").textContent=html1;
            return slogi;
        }

        function joinslogi(slogiFin) {
            toText = slogiFin.join(`-`);
            toText = toText.replace(/--/g, ` `);

            str1 = toText.split(`\n`);
            str1 = str1.map((st) => {
                st = st.trim();
                return (st = st + `\n`);
            });
            toText = str1.join("");
            // if (toText[toText.length-2] == '-'){
            //     toText = toText[0,toText.length-2]+'\n'
            //     console.log('!!!');
            // }
            toText = toText.replace('-\n', ` \n`)

            return toText;
        }
</script>
    
<script>
        
        wwr_start();
        
        wwr_req_recur("GET/PROJEXTSTATE/2ZS_Lyrics/regionName", 2050);
        wwr_req_recur("GET/PROJEXTSTATE/2ZS_Lyrics/allLyric", 2000);
        wwr_req_recur("GET/PROJEXTSTATE/2ZS_Lyrics/text", 1000);
        wwr_req_recur("TRANSPORT", 10);
        
        
        allLyric ='no'
        // slogiFinRezerv = []
        // tText=''
        // let slogiFin = [];
        var regionName = "noSet";
        var text = "";
        // var div = document.getElementById("text");
        // var initial_text = div.innerHTML;
        // console.log(initial_text)
        var playstate_elm = document.getElementById("playstate");
        var colors = [
            "#333333",
            "#00FF00",
            "#FFFF00",
            "#333333",
            "#333333",
            "#FF0000",
            "#FFFF00",
        ]; // playstate is 0 for stopped, 1 for playing, 2 for paused, 5 for recording, and 6 for record paused.
        var detectMultiLine = true;
        var lastDetectMultine = false;

        function GetTabMaxLength(tab) {
            //not used
            let length = 0;
            for (let i in tab) {
                let line = tab[i];
                length = Math.max(length, line.length);
            }
            return length;
        }

        function notesPlusSlogi(midiNotesStart, slogi) {
            //делает таблицу из массива начала нот и массива слогов
            //
            let lyrictabla = [];
            let n = 0;

            for (i = 0; i <= slogi.length; ++i) {
                lyrictabla[i] = [];

                lyrictabla[i][1] = slogi[i];
                // console.log('slogggg', slogi[i])

                if ((slogi[i] !== "") & (slogi[i] !== `\n`)) {
                    
                        lyrictabla[i][0] = midiNotesStart[n];
                        n = ++n;
                    if (n > midiNotesStart.length-1)  {

                        lyrictabla[i][0] = 99999999999999999;
                        // n = ++n;
                        // i = slogi.length

                    }
                    
                    if (n > midiNotesStart.length) {
                        // console.log(lyrictabla);
                        //console.log("КОЛ-ВО НОТ НЕ СОВПАДАЕТ СО СЛОГАМИ")
                        //  ЕСЛИ КОЛ-ВО НОТ НЕ СОВПАДАЕТ СО СЛОГАМИ
                    }
                    // console.log(lyrictabla[i][0],lyrictabla[i][1])
                }
            }
            // console.log(lyrictabla)
            proverkaNotesSlogi(midiNotesStart, n);
            return lyrictabla;
        }

        function proverkaNotesSlogi(midiNotesStart, n) {
            //document.getElementById("notes").textContent = midiNotesStart.length
            //document.getElementById("slogi").textContent = n
            var x = document.getElementById("message");


            if (midiNotesStart.length > n) {
                //console.log(`НОТ БОЛЬШЕ СЛОГОВ - НОТ: ${midiNotesStart.length}, СЛОГОВ ${n}`)
                document.getElementById(
                    "message"
                ).textContent = `НОТ: ${midiNotesStart.length-1}, СЛОГОВ ${n-1}`;
                x.style.color = "red";
            }
            if (midiNotesStart.length < n) {
                //console.log()
                document.getElementById(
                    "message"
                ).textContent = `НОТ: ${midiNotesStart.length-1}, СЛОГОВ ${n-1}`;
                x.style.color = "yellow";
            }

            if (midiNotesStart.length == n) {
                x.style.color = "green";
                document.getElementById(
                    "message"
                ).textContent = `КОЛИЧЕСТОВ НОТ И СЛОГОВ СОВПАДАЕТ: ${n-1}`;
            }
        }

        function wwr_onreply(results) {
            //let textP = document.getElementById('textLyr').textContent
            // console.log(results)
            // let lyric = []; // раньше обнулял ... увеличил интервал запраса текста и он стал мигать. Убрал очищение- перестал исчезать
            // let txtToScr = "";
            // allLyric = 'nooooo'
            let slogiFin = [];
            var ar = results.split("\n");
            var x;
            for (x = 0; x < ar.length; x++) {
                var tok = ar[x].split("\t");
                if (
                    tok.length > 1 &&
                    tok[1] === "2ZS_Lyrics" &&
                    tok[2] === "notes" &&
                    (text !== tok[3])
                    //  || lastDetectMultine !== detectMultiLine)


                ) {
                    TextFromNotes = tok[3];
                    console.log(TextFromNotes);
                    console.log("notes");
                    document.getElementById("textLyr").textContent = TextFromNotes;

                    wwr_req_recur_cancel("GET/PROJEXTSTATE/2ZS_Lyrics/notes");
                    var section = "notes";
                    var key = "read";
                    var value = "n";
                    wwr_req("SET/EXTSTATEPERSIST/" + section + "/" + key + "/" + value);
                    // wwr_req_cancel("SET/EXTSTATEPERSIST/"+section+"/"+key+"/"+value);
                }

                if (
                    tok.length > 1 && 
                    tok[1] === "2ZS_Lyrics" && 
                    tok[2] === "regionName" && 
                    (tok[3] !== regionName)
                )
                    //  || lastDetectMultine !== detectMultiLine)
                 {
                    regionName = tok[3];
                    document.getElementById("fileName").textContent = regionName  
            }

                if (
                    tok.length > 1 &&
                    tok[1] === "2ZS_Lyrics" &&
                    tok[2] === "text"
                    // (tok[3] !== text)
                    //    || lastDetectMultine !== detectMultiLine)
                ) {
                    text = tok[3];

                    /*if( lastDetectMultine !== detectMultiLine ) {
                       lastDetectMultine = detectMultiLine;
                         }*/
                    if (text === "") {
                        // If no script run on use side
                        div.innerHTML = initial_text;
                    } else {
                        if (text === "--2ZS-NO-TEXT--") {
                            text = ""
                        };
                        // var html = text.split("|");

                        var midiNotesStart = text.split("|");

                        //console.log('midiNotesStart',midiNotesStart)
                        // console.log (document.getElementById('textLyr').textContent)

                        lyric = notesPlusSlogi(
                            midiNotesStart,
                            getSlogi(document.getElementById("textLyr").textContent)
                        );

                       
                    }
                }

                

                if (
                    tok.length > 1 &&
                    tok[1] === "2ZS_Lyrics" &&
                    tok[2] === "allLyric" &&
                    (tok[3] !== allLyric  )
                    //  || lastDetectMultine !== detectMultiLine)
                ) {
                    allLyric = tok[3];
                    console.log(allLyric);
                }

                if (tok.length > 1 && 
                    tok[0] === "TRANSPORT"
                ) {
                    // TRANSPORT \t playstate \t position_seconds \t isRepeatOn \t position_string \t position_string_beats
                    playstate_elm.style.background = colors[tok[1]];
                    playstate = tok[1];
                    position_seconds = tok[2];
                    isRepeatOn = tok[3];
                    position_string = tok[4];
                    position_string_beats = tok[5];
                    let txtToScr = "";

                    // console.log ('playstate', playstate)
                    // console.log ('position_seconds', position_seconds)
                    // console.log ('isRepeatOn', isRepeatOn)
                    // console.log ('position_string', position_string)
                    // console.log ('position_string_beats', position_string_beats)
                    document.getElementById("transport").textContent = position_seconds;
                    // console.log("lyric", lyric)

                    //     console.log('position_seconds',position_seconds)

                    for (i = 0; i < lyric.length; ++i) {
                        //текст на экране исчезает из-за того что нижеследующее условие не выполняется, 
                        // следовательно массив с текстом для вывода не формируется, а предыдущий стирается
                        // решил частично.... на уровне функции формирования таблицы лирики с таймкодом notesPlusSlogi()
                        // console.log('i!!!!',i)
                        
                        if (parseFloat(lyric[i][0]) > parseFloat(position_seconds)) {
                            // console.log("i",i);
                            // console.log('lyric[i][0]',lyric[i][0])
                            // console.log('position_seconds',position_seconds)
                            for (n = 0; n < i; ++n) {
                                // console.log('n',n)
                                slogiFin.push(lyric[n][1]);// формирования текста для вывоа на экран
                              
                                txtToScr = txtToScr + lyric[n][1];// старый вариант вывода, недоделаный
                                // console.log('txtToScr',txtToScr)
                            }
                            i = lyric.length; // брейк цикла
                        }
                    }

                    // console.log('!!!!!!slogiFin',slogiFin)
                    // //document.getElementById('lyrics').textContent = txtToScr
                    // console.log('joinslogi(slogiFin)',joinslogi(slogiFin))
                    
                    tText = joinslogi(slogiFin);
                    // console.log('tText',tText) 
                    // document.getElementById("lyrics").textContent = tText ;

                    ttt = document.getElementById("textLyr").textContent;
                    // document.getElementById("lyrics").innerHTML = tText.slice (0, tText.lastIndexOf("-")) + 
                    // '<mark>' + tText.slice (tText.lastIndexOf("-"), tText.length) + '</mark>' + 
                    // ttt.slice(tText.length-1, ttt.length) ;
                    for (x = 0; x < 5; x++) {
                        if (tText.slice(-1) == '\n') {
                            tText=tText.slice (0, tText.length-1)
                            // console.log(tText);
                        }
                        if (tText.slice(-1) == ' ') {
                            tText=tText.slice (0, tText.length-1)
                            // console.log(tText);
                        }
                        
                    }

                    tText.lastIndexOf("\n")

                   if (tText.lastIndexOf("-") > tText.lastIndexOf(" ")) {
                    last = tText.lastIndexOf("-")
                   } else {
                    last = tText.lastIndexOf(" ")
                   }

                   if (last > tText.lastIndexOf("\n")) {
                    last = last
                   } else {
                    last = tText.lastIndexOf("\n")
                   }



                    document.getElementById("lyrics").innerHTML = 
                        tText.slice (0, last+1) + 
                            '<mark>' +
                        tText.slice (last+1, tText.length) + 
                            '</mark>' +
                    ttt.slice(tText.length, ttt.length) ;
                    // console.log(tText.lastIndexOf("-", ' '));




                    // console.log( document.getElementById("lyrics").textContent);
                    
                   if  (document.getElementById("showBig").checked){
                    document.getElementById("prev").hidden = false
                        // previewSl = splitMulti(tText.trimEnd(),['-',' ','\n\n','\n'])
                        previewStr = splitMulti(tText.trimEnd(),['\n'])
                        
                        // console.log(preview.length);
                        // previewSl = previewSl.filter(n => n) 
                        previewStr = previewStr.filter(n => n)
                        // previewStr = previewStr.filter('-' ,'')

                        // document.getElementById("prev").textContent = previewSl[previewSl.length - 1] 
                        document.getElementById("prev").textContent = previewStr[previewStr.length - 1]
                        // console.log(tText.split('-'));
                    
                        // document.getElementById( 
                        //         "fileName"
                        //     ).textContent = regionName;
                        //     x.style.color = "blue";
                   } else {
                    document.getElementById("prev").hidden = true

                   }

                    


                }
            }
        }
        document.querySelector("#test0").addEventListener("click", function() {

            console.log(lyric, position_seconds);
            console.log('previewStr', previewStr);
            console.log('tText', tText);

           
        })

        /*
    div.addEventListener('dblclick', function(e){
      lastDetectMultine = detectMultiLine;
      detectMultiLine = !detectMultiLine;
    })*/
    </script>

    <!-- <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="viewport" id="viewport-meta" content="" />
</head>
<body onLoad="init()"> -->
    <!-- <div id="lyrics" onclick="lyrics_config()">initializing...</div> -->
</body>

</html>